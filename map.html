<!DOCTYPE html>
<html>
<head>
    <title>מפה עם נקודות מ-Google Sheets</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { height: 100vh; width: 100vw; position: fixed; top: 0; left: 0; }
    </style>
</head>
<body>
    <div id="map"></div>
    <button onclick="loadMarkers()">רענן נקודות</button>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([31.9316, 35.0386], 14); // מודיעין עילית
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        var markers = [];

        function clearMarkers() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
        }

        function addMarker(lat, lng, color, popupText) {
            // הגדר אייקון צבעוני
            var icon = L.icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color || 'blue'}.png`,
                shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
            var marker = L.marker([lat, lng], {icon: icon}).addTo(map);
            if (popupText) marker.bindPopup(popupText);
            markers.push(marker);
        }

        function loadMarkers() {
            clearMarkers();
            // החלף SHEET_ID ב-ID של הגיליון שלך
            var sheetUrl = "https://docs.google.com/spreadsheets/d/1owVQASqFEFsnLh15n6LNwJrnoUEjaRHn1rh5GRADBwU/gviz/tq?tqx=out:csv";
            fetch(sheetUrl)
                .then(response => response.arrayBuffer())
                .then(buffer => {
                    // ודא קידוד UTF-8
                    var csv = new TextDecoder("utf-8").decode(buffer);
                    // ניתוח CSV עם PapaParse (מטפל בעברית, תווים מיוחדים, גרשיים וכו')
                    var results = Papa.parse(csv, {header: true});
                    results.data.forEach(row => {
                        if (row.lat && row.lng) {
                            // color: red/green/orange/blue/violet/grey/yellow (לפי התמיכה באייקונים)
                            addMarker(
                                parseFloat(row.lat),
                                parseFloat(row.lng),
                                (row.color || 'blue').toLowerCase(),
                                row.name // או כל עמודה אחרת לפופאפ
                            );
                        }
                    });
                });
        }

        // טען נקודות בהתחלה
        loadMarkers();
    </script>
</body>
</html>

